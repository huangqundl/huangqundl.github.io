<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Yahoo! S4安装手记 - 灵魂熔炉</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://huangqundl.github.io/blog/posts/2012-Aug-s4-install">

        <meta name="author" content="huangqundl" />
        <meta name="keywords" content="tech,stream" />

        <meta property="og:site_name" content="灵魂熔炉" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Yahoo! S4安装手记"/>
        <meta property="og:url" content="http://huangqundl.github.io/blog/posts/2012-Aug-s4-install"/>
        <meta property="og:description" content=""/>
        <meta property="article:published_time" content="2012-08-23" />
            <meta property="article:section" content="Tech" />
            <meta property="article:tag" content="tech" />
            <meta property="article:tag" content="stream" />
            <meta property="article:author" content="huangqundl" />


    <link rel="stylesheet" type="text/css" href="http://huangqundl.github.io/blog/theme/css/quote.css" />
    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://huangqundl.github.io/blog/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://huangqundl.github.io/blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://huangqundl.github.io/blog/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://huangqundl.github.io/blog/theme/css/style.css" type="text/css"/>

        <link href="http://huangqundl.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="灵魂熔炉 ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://huangqundl.github.io/blog/" class="navbar-brand">
                <!--灵魂熔炉-->
                Blog
            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="http://huangqundl.github.io/blog/pages/guan-yu.html">
                             关于
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://huangqundl.github.io/blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<style>
	#banner{
	    background-image:url("http://huangqundl.github.io/blog/True");
	}
</style>

<div id="banner">
	<div class="container">
		<div class="copy">
			<h1>灵魂熔炉</h1>
            <br>
				<p class="intro">"Life is tough, so you must work harder."</p>
		</div>
	</div>
</div><!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="http://huangqundl.github.io/blog/posts/2012-Aug-s4-install"
                       rel="bookmark"
                       title="Permalink to Yahoo! S4安装手记">
                        Yahoo! S4安装手记
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2012-08-23T15:22:00+02:00"> Thu 23 August 2012</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="http://huangqundl.github.io/blog/tag/tech.html">tech</a>
        /
	<a href="http://huangqundl.github.io/blog/tag/stream.html">stream</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>S4是Yahoo!在2010年发布的一个分布式处理框架. 不同于MapReduce的面向批处理应用，S4面向的应用主要是数据流的处理（类似于Hadoop Stream）.具体的细节可以看他们在KDCloud 2010上的<a href="http://www.4lunas.org/pub/2010-s4.pdf">Paper</a>，以及<a href="http://incubator.apache.org/s4">官方网站</a>.</p>
<p>目前整个项目还只是Alpha版（七月底的时候刚刚进行了一次重构，上周五发布了0.5.0版本）.但对于我这样的CS初学者来说，一个还处于雏形的项目上手成本相对会低一些吧（相对于Linux Kernel或许Xen）.</p>
<p>本文基本是把wiki上的<a href="https://cwiki.apache.org/confluence/display/S4/S4+piper+walkthrough">WalkThrough</a>走了一遍，以及一些自己遇到的一些问题.</p>
<h3>平台：Ubuntu 10.04 + Sun Java 6.</h3>
<h2>1. 下载</h2>
<p>使用git下载代码包，进入S4根目录.
<pre><code>git clone https://git-wip-us.apache.org/repos/asf/incubator-s4.git
cd incubator-s4/
</code></pre></p>
<p>当然也可以<a href="http://incubator.apache.org/s4/download">官网</a>直接下载.</p>
<h2>2. 配置代理</h2>
<p>安装时，许多包需要通过网络下载，所有工作都基于一个叫gradle的项目. lib/下就是gradle的jar包，它通过根目录下的gradlew调用。如果所在环境需要代理才能上网，则必须在gradle中添加HTTP与HTTPS代理。添加的方法有很多种，我是直接打开gradlew文件，然后在</p>
<pre><code>exec "$JAVACMD" "${JVM_OPTS[@]}" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
</code></pre>

<p>之前加上</p>
<pre><code>JVM_OPTS[${#JVM_OPTS[*]}]="-Dhttp.proxyHost=proxy.cse.cuhk.edu.hk"
JVM_OPTS[${#JVM_OPTS[*]}]="-Dhttp.proxyPort=8000"
JVM_OPTS[${#JVM_OPTS[*]}]="-Dhttps.proxyHost=proxy.cse.cuhk.edu.hk"
JVM_OPTS[${#JVM_OPTS[*]}]="-Dhttps.proxyPort=8000"
</code></pre>

<p>具体的代理服务器与端口自己设置.</p>
<h2>3. 编译与安装</h2>
<p>期间会下载一些第三方的包，比如S4中用来容错的ZooKeeper.</p>
<pre><code>./gradlew install -DskipTests
./gradlew s4-tools:installApp
</code></pre>

<h2>4. 新建一个应用程序</h2>
<pre><code>mkdir tmp
./s4 newApp myApp -parentDir=tmp
</code></pre>

<p>然后在tmp下就会看到一个myApp文件夹，默认S4会创建一个HelloWorld的模板样例.这里我们就用这个样例进行演示.</p>
<h2>5. 为新建的应用程序配置运行环境</h2>
<p>首先，启动ZooKeeper服务器.</p>
<pre><code>./s4 zkServer
</code></pre>

<p>需要注意的是，如果在终端中打开ZooKeeper，这个终端不能关闭，需要在新的终端中继续后面的配置。</p>
<p>接着，建立一个cluster.</p>
<pre><code>./s4 newCluster -c=cluster1 -nbTasks=2 -flp=12000
</code></pre>

<p>这里集群的名字叫cluster1，（期望）包含两个节点，节点的端口号从12000开始顺序分配，即两个节点的端口号为12000与12001.</p>
<p>然后，在cluster1中新建两个节点。</p>
<pre><code>./s4 node -c=cluster1
</code></pre>

<p>类似ZooKeeper，新建节点后不能关闭终端，因此在另一个终端中重复执行</p>
<pre><code>./s4 node -c=cluster1
</code></pre>

<h2>6. 把样例应用部署到cluster1上</h2>
<pre><code>./s4 deploy -appName=myApp -c=cluster1 -b=tmp/myApp/build.gradle -a=hello.HelloApp
</code></pre>

<p>注意-b参数使用的是myApp下的build.gradle文件，而不是s4根目录下的。</p>
<p>另外，命令过程中需要用gradle下载一些第三方包，这里涉及到了另一种代理设置方法：在myApp下的gradle.properties文件（没有就新建一个）中写入</p>
<pre><code>systemProp.http.proxyHost=proxy.cse.cuhk.edu.hk
systemProp.http.proxyPort=8000
systemProp.https.proxyHost=proxy.cse.cuhk.edu.hk
systemProp.https.proxyPort=8000
</code></pre>

<p>查看</p>
<pre><code>./s4 status
</code></pre>

<p>即可得到样例应用信息.</p>
<h2>7. 为样例应用装配输入流</h2>
<p>S4中的信息是通过流（Stream）传播的. 对于应用外部的信息，需要用Adapter将它们转化成相应的流. 样例应用中的HelloInputAdapter通过监听系统中的15000端口，把发往该端口的信息转换成了样例应用的输入流。</p>
<p>由于Adapter也是一种特殊的应用，因此也需要为HelloInputAdapter配置运行环境.</p>
<pre><code>./s4 newCluster -c=cluster2 -nbTasks=1 -flp=13000
</code></pre>

<p>cluser2只有一个节点，端口号为13000.</p>
<p>部署Adapter的方法有两种：</p>
<h3>7.a. 进入myApp根目录，部署HelloInputAdapter.</h3>
<pre><code>cd tmp/myApp
./s4 adapter -appClass=hello.HelloInputAdapter -c=cluster2 -p=s4.adapter.output.stream=names
</code></pre>

<p>需要注意的是，这个命令是对于添加adapter型节点的一个封装，它根据已有的应用（比如myApp）自动匹配adapter，因此需要在myApp文件下执行.</p>
<h3>7.b. 用传统的方法添加节点.</h3>
<pre><code>./s4 node -c=cluster2 -p=s4.adapter.output.stream=names
./s4 deploy -appName=HelloInputAdapter -c=cluster2 -b=tmp/myApp/build.gradle -a=hello.HelloInputAdapter
</code></pre>

<h2>8. 执行</h2>
<p>往15000端口发送信息，即可在cluster1的两个节点的终端中看到输出了.</p>
<pre><code>echo "qhuang" | nc localhost 15000
</code></pre>

<h2>9. 在Eclipse中查看代码</h2>
<p>Linux下只需在S4根目录下执行</p>
<pre><code>./gradlew eclipse
</code></pre>

<p>即可把subprojects下的项目导入Eclipse.</p>
<p>但在Windows下没有这个命令，导入subprojects会找不到对应的第三方jar包. 我的做法是，在Linux下执行后，把~/.gradle/caches/artifacts-13/filestore/拷贝到windows中，然后再把subprojects中的第三方jar包指向windows下filestore文件夹里对应的jar包. 如果嫌在Eclipse中一个个改麻烦的话，一种快速的修改方法是，修改每个project下的.classpath文件.</p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="#"><i class="fa fa-you-can-add-links-in-your-config-file-square fa-lg"></i> You can add links in your config file</a></li>
                <li class="list-group-item"><a href="#"><i class="fa fa-another-social-link-square fa-lg"></i> Another social link</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="http://huangqundl.github.io/blog/tags"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group list-inline tagcloud" id="tags">
                    <li class="list-group-item tag-4">
                        <a href="http://huangqundl.github.io/blog/tag/life.html">
                            life
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://huangqundl.github.io/blog/tag/soccer.html">
                            soccer
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://huangqundl.github.io/blog/tag/stream.html">
                            stream
                        </a>
                    </li>
                    <li class="list-group-item tag-4">
                        <a href="http://huangqundl.github.io/blog/tag/tech.html">
                            tech
                        </a>
                    </li>
                </ul>
            </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <!--
        <li class="list-group-item">
            <a href="http://getpelican.com/" target="_blank">
                Pelican
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://python.org/" target="_blank">
                Python.org
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://jinja.pocoo.org/" target="_blank">
                Jinja2
            </a>
        </li>
        <li class="list-group-item">
            <a href="#" target="_blank">
                You can modify those links in your config file
            </a>
        </li>
        -->
      </ul>
    </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2012 huangqundl
             &middot; 
             Theme by <a href="https://github.com/huangqundl/pelican-template/tree/master/theme/huangqundl-bootstrap3" target="_blank">huangqundl-bootstrap3</a>,
             Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://huangqundl.github.io/blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://huangqundl.github.io/blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://huangqundl.github.io/blog/theme/js/respond.min.js"></script>

    <script src="http://huangqundl.github.io/blog/theme/js/bodypadding.js"></script>

</body>
</html>